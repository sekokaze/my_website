<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ¸…åº“å­˜æ‰“ç –å— - IPI åˆ†æ•°ä¿å«æˆ˜</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap');

        body {
            font-family: 'Roboto', sans-serif;
            background-color: #232F3E; /* Amazon Dark Blue */
            color: white;
            overflow: hidden;
            touch-action: none; /* ç¦æ­¢é»˜è®¤è§¦æ‘¸åŠ¨ä½œ */
        }

        #game-container {
            position: relative;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            margin: 0 auto;
        }

        canvas {
            background-color: #f3f3f3;
            display: block;
            border-bottom: 6px solid #FF9900;
        }

        /* IPI ä»ªè¡¨ç›˜ */
        .ipi-meter {
            width: 100%;
            height: 8px;
            background: #ddd;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 4px;
        }
        .ipi-fill {
            height: 100%;
            background: linear-gradient(90deg, #ef4444 0%, #eab308 50%, #22c55e 100%);
            width: 100%; /* JS æ§åˆ¶ */
            transition: width 0.3s ease;
        }

        /* Modal Overlay */
        .modal {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(35, 47, 62, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 50;
            backdrop-filter: blur(4px);
            padding: 20px;
        }
        .hidden { display: none !important; }

        .btn-primary {
            background: #FF9900;
            color: #111;
            font-weight: bold;
            padding: 12px 32px;
            border-radius: 99px;
            border: 2px solid #fff;
            transition: all 0.2s;
            font-size: 1.1rem;
            cursor: pointer;
        }
        .btn-primary:active { transform: scale(0.95); }
        .btn-primary:hover { filter: brightness(1.1); }

        /* é£˜å­—ç‰¹æ•ˆ */
        .floating-text {
            position: absolute;
            font-weight: bold;
            pointer-events: none;
            animation: floatUp 0.8s ease-out forwards;
            font-size: 14px;
        }
        @keyframes floatUp {
            0% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-30px); }
        }
    </style>
</head>
<body class="h-screen flex flex-col">

    <!-- é¡¶éƒ¨ HUD -->
    <div id="game-hud" class="bg-gray-800 p-3 shadow-md z-10 shrink-0">
        <!-- æ–°å¢ï¼šæ¸¸æˆæ ‡é¢˜æ  -->
        <div class="max-w-md mx-auto mb-2 flex items-center gap-2 border-b border-gray-700 pb-2">
            <i class="fas fa-boxes text-yellow-500"></i>
            <h1 class="font-bold text-white text-sm tracking-wide italic">IPI åˆ†æ•°ä¿å«æˆ˜</h1>
            <span class="text-[10px] text-gray-500 bg-gray-900 px-1 rounded ml-auto">v1.1</span>
        </div>

        <!-- åŸæœ‰ï¼šæ•°æ®ç»Ÿè®¡ -->
        <div class="max-w-md mx-auto flex justify-between items-end mb-1">
            <div>
                <div class="text-xs text-gray-400">èŠ‚çœä»“å‚¨è´¹ (Saved)</div>
                <div class="text-xl font-bold text-green-400">$<span id="score-display">0</span></div>
            </div>
            <div class="text-right w-1/2">
                <div class="flex justify-between text-xs text-gray-400 mb-1">
                    <span>IPI åˆ†æ•°</span>
                    <span id="ipi-value" class="font-bold text-green-400">500</span>
                </div>
                <div class="ipi-meter">
                    <div id="ipi-bar" class="ipi-fill" style="width: 80%;"></div>
                </div>
                <div class="flex justify-between text-[10px] text-gray-500 mt-1">
                    <span>0</span>
                    <span class="text-red-400">350</span>
                    <span>1000</span>
                </div>
            </div>
        </div>
    </div>

    <!-- æ¸¸æˆåŒºåŸŸ -->
    <div class="flex-1 flex items-center justify-center bg-gray-900 w-full overflow-hidden">
        <div id="game-container" class="relative">
            <canvas id="gameCanvas"></canvas>
            
            <!-- åˆå§‹ä»‹ç»å¼¹çª— (Start Screen) -->
            <div id="start-screen" class="modal">
                <div class="bg-gray-800 p-6 rounded-lg max-w-sm w-full border border-gray-600 shadow-2xl relative">
                    <!-- è£…é¥°èƒŒæ™¯å›¾æ ‡ -->
                    <i class="fas fa-warehouse absolute -top-6 -right-6 text-8xl text-gray-700 opacity-20 pointer-events-none"></i>
                    
                    <div class="text-center mb-6 relative z-10">
                        <div class="inline-block p-3 bg-gray-700 rounded-full mb-3 border border-gray-600">
                            <i class="fas fa-boxes text-4xl text-yellow-500"></i>
                        </div>
                        <h1 class="text-2xl font-bold text-white tracking-tight">IPI åˆ†æ•°ä¿å«æˆ˜</h1>
                        <div class="text-[10px] text-gray-400 uppercase tracking-[0.2em] mt-1">IPI Defense</div>
                    </div>
                    
                    <div class="space-y-4 text-sm text-gray-300 mb-8 relative z-10">
                        <div class="flex items-start gap-3">
                            <div class="mt-1 min-w-[20px] text-center"><i class="fas fa-exclamation-circle text-red-400"></i></div>
                            <div>
                                <span class="text-white font-bold block mb-0.5">å±æœºè­¦å‘Š</span>
                                ä»“åº“çˆ†ä»“ï¼ŒIPI åˆ†æ•°å²Œå²Œå¯å±ï¼è·Œç ´ <span class="text-red-400 font-bold">350åˆ†</span> å°†è¢«é™åˆ¶å‘è´§ã€‚
                            </div>
                        </div>
                        
                        <div class="flex items-start gap-3">
                            <div class="mt-1 min-w-[20px] text-center"><i class="fas fa-gamepad text-orange-400"></i></div>
                            <div>
                                <span class="text-white font-bold block mb-0.5">æ“ä½œæŒ‡å—</span>
                                å·¦å³æ»‘åŠ¨ <span class="text-orange-400 font-bold">Coupon æŠ˜æ‰£åˆ¸</span> æ¥ä½æµé‡çƒï¼Œå‡»ç¢ä¸Šæ–¹å†—ä½™åº“å­˜ã€‚
                            </div>
                        </div>

                        <div class="bg-gray-900/50 p-3 rounded border border-gray-700 text-xs text-center text-gray-400">
                            <i class="fas fa-skull-crossbones mr-1"></i> æ³¨æ„ï¼šæ¯æ¼æ¥ä¸€ä¸ªçƒï¼ŒIPI æ‰£ <span class="text-red-400 font-bold">50åˆ†</span>ï¼
                        </div>
                    </div>

                    <button onclick="startGame()" class="w-full btn-primary flex items-center justify-center gap-2 text-lg group relative z-10 shadow-lg shadow-orange-900/20">
                        <span>ç«‹å³æ¸…è´§</span>
                        <i class="fas fa-arrow-right group-hover:translate-x-1 transition-transform"></i>
                    </button>
                </div>
            </div>

            <!-- ç»“ç®—ç•Œé¢ (Game Over Screen) -->
            <div id="game-over-screen" class="modal hidden">
                <i id="result-icon" class="fas fa-exclamation-triangle text-6xl text-red-500 mb-4 animate-bounce"></i>
                <h2 id="result-title" class="text-2xl font-bold mb-2 text-white">é™åˆ¶å‘è´§!</h2>
                <p id="result-desc" class="text-gray-400 text-sm mb-6 text-center px-6">IPI åˆ†æ•°è¿‡ä½ï¼Œè´¦å·è¢«é™åˆ¶ã€‚</p>
                
                <div class="grid grid-cols-2 gap-4 mb-8 w-full px-8 max-w-sm">
                    <div class="bg-gray-700 p-3 rounded text-center border border-gray-600">
                        <div class="text-xs text-gray-400 uppercase">æœ€ç»ˆ IPI</div>
                        <div id="final-ipi" class="text-2xl font-bold text-white">0</div>
                    </div>
                    <div class="bg-gray-700 p-3 rounded text-center border border-gray-600">
                        <div class="text-xs text-gray-400 uppercase">èŠ‚çœè´¹ç”¨</div>
                        <div id="final-score" class="text-2xl font-bold text-green-400">$0</div>
                    </div>
                </div>

                <button onclick="startGame()" class="btn-primary flex items-center gap-2">
                    <i class="fas fa-redo"></i> é‡æ–°å¼€å§‹
                </button>
            </div>
            
            <!-- è§¦æ‘¸æç¤º -->
            <div id="touch-hint" class="absolute bottom-20 w-full text-center pointer-events-none opacity-50 animate-pulse text-gray-800 hidden font-bold text-lg">
                <span class="bg-white/80 px-4 py-2 rounded-full shadow-lg backdrop-blur-sm">
                    <i class="fas fa-hand-pointer mr-2"></i> å·¦å³æ‹–åŠ¨æ§åˆ¶æŠ˜æ‰£åˆ¸
                </span>
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const container = document.getElementById('game-container');
        const hud = document.getElementById('game-hud'); // è·å– HUD å…ƒç´ 

        // --- æ¸¸æˆé…ç½® ---
        let dpr = window.devicePixelRatio || 1;
        let animationId;
        let isRunning = false;

        // IPI ç³»ç»Ÿ
        const MAX_IPI = 1000;
        const MIN_IPI = 350; // ä½äºè¿™ä¸ªæ­»ç¿˜ç¿˜
        const START_IPI = 500;
        const IPI_PENALTY = 50; // æ‰ä¸€ä¸ªçƒæ‰£50åˆ†

        let gameState = {
            score: 0,
            ipi: START_IPI,
            level: 1
        };

        // å¯¹è±¡å±æ€§
        const ball = {
            x: 0, y: 0,
            dx: 0, dy: 0,
            radius: 6,
            speed: 5,
            color: '#232F3E' // Amazon Blue
        };

        const paddle = {
            x: 0, y: 0,
            width: 100, height: 16,
            color: '#FF9900', // Amazon Orange
            text: '50% OFF'
        };

        let bricks = [];
        const brickConfig = {
            rowCount: 5,
            colCount: 5, // ä¼šæ ¹æ®å®½åº¦åŠ¨æ€è®¡ç®—
            padding: 8,
            offsetTop: 40,
            offsetLeft: 20,
            height: 20
        };

        // --- åˆå§‹åŒ–ä¸å“åº”å¼ ---
        function resizeGame() {
            // è·å– HUD çš„å®é™…é«˜åº¦
            const hudHeight = hud.offsetHeight;

            // è·å–çˆ¶å®¹å™¨å®½åº¦ï¼Œæœ€å¤§ä¸è¶…è¿‡ 600
            const maxWidth = Math.min(window.innerWidth, 600);
            // åŠ¨æ€è®¡ç®—æœ€å¤§é«˜åº¦ï¼šçª—å£é«˜åº¦ - HUD é«˜åº¦
            const maxHeight = window.innerHeight - hudHeight; 
            
            // è®¾ç½®æ˜¾ç¤ºå°ºå¯¸
            canvas.style.width = maxWidth + "px";
            canvas.style.height = maxHeight + "px";
            
            // è®¾ç½®æ¸²æŸ“å°ºå¯¸
            canvas.width = maxWidth * dpr;
            canvas.height = maxHeight * dpr;
            ctx.scale(dpr, dpr);

            // é‡ç½®æŒ¡æ¿ä½ç½®
            paddle.y = (canvas.height / dpr) - 40;
            paddle.x = ((canvas.width / dpr) - paddle.width) / 2;

            // åŠ¨æ€è®¡ç®—ç –å—åˆ—æ•°
            const availableWidth = (canvas.width / dpr) - (2 * brickConfig.offsetLeft);
            // å‡è®¾æ¯ä¸ªç –å—å¤§çº¦ 60px å®½
            brickConfig.colCount = Math.floor(availableWidth / 65);
            // è®¡ç®—è‡ªé€‚åº”å®½åº¦
            brickConfig.width = (availableWidth - (brickConfig.colCount - 1) * brickConfig.padding) / brickConfig.colCount;

            // æ— è®ºæ˜¯å¦è¿è¡Œä¸­ï¼Œéƒ½è¦åˆå§‹åŒ–èƒŒæ™¯ï¼Œå¦åˆ™å¼¹çª—åé¢æ˜¯ç™½çš„
            if (!isRunning) {
                // åˆå§‹åŒ–ä¸€å¥—é™æ€æ•°æ®ç”¨äºå±•ç¤ºèƒŒæ™¯
                initBricks();
                // ç»˜åˆ¶ä¸€å¸§é™æ€ç”»é¢
                ctx.clearRect(0, 0, canvas.width / dpr, canvas.height / dpr);
                drawBricks();
                // æŠŠæŒ¡æ¿ç”»åœ¨ä¸­é—´
                paddle.x = ((canvas.width / dpr) - paddle.width) / 2;
                drawPaddle();
            }
        }

        window.addEventListener('resize', resizeGame);

        // --- æ¸¸æˆé€»è¾‘ ---

        function initBricks() {
            bricks = [];
            for (let c = 0; c < brickConfig.colCount; c++) {
                bricks[c] = [];
                for (let r = 0; r < brickConfig.rowCount; r++) {
                    // å®šä¹‰ç –å—ç±»å‹
                    let type = 'normal'; // ğŸ“¦
                    let health = 1;
                    let color = '#4ade80'; // Green (Safe)
                    let scoreValue = 10;
                    
                    if (r === 0) { // é¡¶éƒ¨æœ€å±é™©
                        type = 'unsellable'; // ğŸŸ¥
                        health = 2; // ç¡¬éª¨å¤´
                        color = '#ef4444'; // Red
                        scoreValue = 50;
                    } else if (r === 1 || r === 2) {
                        type = 'longterm'; // ğŸŸ¨
                        health = 1;
                        color = '#eab308'; // Yellow
                        scoreValue = 30;
                    }

                    bricks[c][r] = { 
                        x: 0, y: 0, 
                        status: 1, 
                        type: type, 
                        health: health,
                        color: color,
                        maxHealth: health,
                        scoreValue: scoreValue
                    };
                }
            }
        }

        function startGame() {
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('game-over-screen').classList.add('hidden');
            document.getElementById('touch-hint').classList.remove('hidden');
            
            // 3ç§’åéšè—æç¤º
            setTimeout(() => document.getElementById('touch-hint').classList.add('hidden'), 3000);

            // é‡ç½®çŠ¶æ€
            gameState.score = 0;
            gameState.ipi = START_IPI;
            
            resizeGame(); // ç¡®ä¿å°ºå¯¸æ­£ç¡®
            initBricks();
            resetBall();
            updateUI();

            isRunning = true;
            draw();
        }

        function resetBall() {
            ball.x = (canvas.width / dpr) / 2;
            ball.y = (canvas.height / dpr) - 60;
            ball.dx = 4 * (Math.random() > 0.5 ? 1 : -1); // éšæœºå·¦å³
            ball.dy = -4; // å‘ä¸Šå‘å°„
        }

        function drawBall() {
            ctx.beginPath();
            ctx.arc(ball.x, ball.y, ball.radius, 0, Math.PI * 2);
            ctx.fillStyle = ball.color;
            ctx.fill();
            // æµé‡å…‰æ™•
            ctx.shadowBlur = 10;
            ctx.shadowColor = "rgba(35, 47, 62, 0.5)";
            ctx.closePath();
            ctx.shadowBlur = 0;
        }

        function drawPaddle() {
            // ç»˜åˆ¶ä¼˜æƒ åˆ¸å½¢çŠ¶
            ctx.fillStyle = paddle.color;
            
            // åœ†è§’çŸ©å½¢
            const r = 4;
            ctx.beginPath();
            ctx.moveTo(paddle.x + r, paddle.y);
            ctx.lineTo(paddle.x + paddle.width - r, paddle.y);
            ctx.quadraticCurveTo(paddle.x + paddle.width, paddle.y, paddle.x + paddle.width, paddle.y + r);
            ctx.lineTo(paddle.x + paddle.width, paddle.y + paddle.height - r);
            ctx.quadraticCurveTo(paddle.x + paddle.width, paddle.y + paddle.height, paddle.x + paddle.width - r, paddle.y + paddle.height);
            ctx.lineTo(paddle.x + r, paddle.y + paddle.height);
            ctx.quadraticCurveTo(paddle.x, paddle.y + paddle.height, paddle.x, paddle.y + paddle.height - r);
            ctx.lineTo(paddle.x, paddle.y + r);
            ctx.quadraticCurveTo(paddle.x, paddle.y, paddle.x + r, paddle.y);
            ctx.closePath();
            ctx.fill();

            // è™šçº¿è£…é¥° (åƒä¼˜æƒ åˆ¸çš„æ’•å£)
            ctx.strokeStyle = '#fff';
            ctx.setLineDash([4, 4]);
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(paddle.x + 4, paddle.y + 2);
            ctx.lineTo(paddle.x + paddle.width - 4, paddle.y + 2);
            ctx.stroke();
            ctx.setLineDash([]); // è¿˜åŸ

            // æ–‡å­—
            ctx.fillStyle = '#111';
            ctx.font = 'bold 10px sans-serif';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(paddle.text, paddle.x + paddle.width / 2, paddle.y + paddle.height / 2 + 1);
        }

        function drawBricks() {
            for (let c = 0; c < brickConfig.colCount; c++) {
                for (let r = 0; r < brickConfig.rowCount; r++) {
                    const b = bricks[c][r];
                    if (b.status === 1) {
                        const brickX = (c * (brickConfig.width + brickConfig.padding)) + brickConfig.offsetLeft;
                        const brickY = (r * (brickConfig.height + brickConfig.padding)) + brickConfig.offsetTop;
                        b.x = brickX;
                        b.y = brickY;

                        ctx.beginPath();
                        ctx.rect(brickX, brickY, brickConfig.width, brickConfig.height);
                        
                        // é¢œè‰²æ ¹æ®å‰©ä½™è¡€é‡ç¨å¾®å˜æš—/äº®
                        ctx.fillStyle = b.color;
                        if (b.maxHealth > 1 && b.health === 1) {
                             ctx.fillStyle = '#f87171'; // çº¢è‰²å˜æµ…ä¸€ç‚¹ï¼Œè¡¨ç¤ºå¿«ç¢äº†
                        }
                        
                        ctx.fill();
                        ctx.closePath();

                        // ç»˜åˆ¶ç®±å­çº¹ç†/æ–‡å­—
                        ctx.fillStyle = 'rgba(0,0,0,0.3)';
                        ctx.font = '12px sans-serif';
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        let icon = '';
                        if (b.type === 'unsellable') icon = 'ğŸš«';
                        else if (b.type === 'longterm') icon = 'ğŸ’°';
                        // åªæœ‰å®½åº¦è¶³å¤Ÿæ‰ç”»å›¾æ ‡
                        if (brickConfig.width > 30) {
                             ctx.fillText(icon, brickX + brickConfig.width/2, brickY + brickConfig.height/2);
                        }
                    }
                }
            }
        }

        function collisionDetection() {
            for (let c = 0; c < brickConfig.colCount; c++) {
                for (let r = 0; r < brickConfig.rowCount; r++) {
                    const b = bricks[c][r];
                    if (b.status === 1) {
                        if (ball.x > b.x && ball.x < b.x + brickConfig.width && ball.y > b.y && ball.y < b.y + brickConfig.height) {
                            ball.dy = -ball.dy;
                            
                            // æ‰£è¡€
                            b.health--;
                            
                            // ç‰¹æ•ˆ
                            createFloatingText(b.x + brickConfig.width/2, b.y, `-$${b.scoreValue}`);

                            if (b.health <= 0) {
                                b.status = 0;
                                gameState.score += b.scoreValue;
                                // æ¸…ç†åº“å­˜æœ‰åŠ©äº IPI
                                gameState.ipi = Math.min(MAX_IPI, gameState.ipi + 2); 
                            } else {
                                // æ’å‡»ä½†æœªç¢ï¼Œç»™ä¸€ç‚¹ç‚¹åé¦ˆ
                                gameState.score += 5;
                            }
                            updateUI();
                            checkWin();
                        }
                    }
                }
            }
        }

        function checkWin() {
            // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰ç –å—éƒ½æ¸…é™¤äº†
            let activeBricks = 0;
            for (let c = 0; c < brickConfig.colCount; c++) {
                for (let r = 0; r < brickConfig.rowCount; r++) {
                    if (bricks[c][r].status === 1) activeBricks++;
                }
            }
            if (activeBricks === 0) {
                gameOver(true);
            }
        }

        function update() {
            // ç§»åŠ¨çƒ
            ball.x += ball.dx;
            ball.y += ball.dy;

            // å¢™å£ç¢°æ’
            // å·¦/å³
            if (ball.x + ball.radius > canvas.width / dpr || ball.x - ball.radius < 0) {
                ball.dx = -ball.dx;
            }
            // é¡¶
            if (ball.y - ball.radius < 0) {
                ball.dy = -ball.dy;
            }
            // åº• (Lose Logic)
            else if (ball.y + ball.radius > canvas.height / dpr) {
                // æµé‡æµå¤±ï¼Œæ‰£ IPI
                gameState.ipi -= IPI_PENALTY;
                createFloatingText(ball.x, canvas.height/dpr - 50, "-50 IPI", "red");
                updateUI();

                if (gameState.ipi < MIN_IPI) {
                    gameOver(false);
                } else {
                    resetBall();
                }
            }

            // æŒ¡æ¿ç¢°æ’
            if (ball.y + ball.radius >= paddle.y && 
                ball.y - ball.radius <= paddle.y + paddle.height &&
                ball.x >= paddle.x && 
                ball.x <= paddle.x + paddle.width) {
                
                // ç¡®ä¿åªæœ‰å‘ä¸‹è½æ—¶æ‰åå¼¹
                if (ball.dy > 0) {
                    ball.dy = -ball.dy;
                    
                    // æ ¹æ®å‡»æ‰“ä½ç½®æ”¹å˜ X é€Ÿåº¦
                    const hitPoint = ball.x - (paddle.x + paddle.width / 2);
                    ball.dx = hitPoint * 0.15; 
                    
                    ball.speed = Math.min(ball.speed * 1.02, 8);
                }
            }
        }

        function draw() {
            if (!isRunning) return;

            // æ¸…ç©ºç”»å¸ƒ
            ctx.clearRect(0, 0, canvas.width / dpr, canvas.height / dpr);

            drawBricks();
            drawBall();
            drawPaddle();
            collisionDetection();
            update();

            animationId = requestAnimationFrame(draw);
        }

        function gameOver(win) {
            isRunning = false;
            cancelAnimationFrame(animationId);
            
            const screen = document.getElementById('game-over-screen');
            const title = document.getElementById('result-title');
            const desc = document.getElementById('result-desc');
            const icon = document.getElementById('result-icon');
            
            screen.classList.remove('hidden');
            
            document.getElementById('final-ipi').innerText = gameState.ipi;
            document.getElementById('final-ipi').className = gameState.ipi < MIN_IPI ? "text-2xl font-bold text-red-500" : "text-2xl font-bold text-green-400";
            document.getElementById('final-score').innerText = "$" + gameState.score;

            if (win) {
                title.innerText = "åº“å­˜æ¸…ç©ºï¼";
                title.className = "text-2xl font-bold mb-2 text-green-400";
                desc.innerText = "å¹²å¾—æ¼‚äº®ï¼è¿™æ³¢ Outlet Deal æ•ˆæœæ‹”ç¾¤ï¼ŒIPI åˆ†æ•°ä¿ä½äº†ï¼";
                icon.className = "fas fa-trophy text-6xl text-yellow-400 mb-4 animate-bounce";
            } else {
                title.innerText = "é™åˆ¶å‘è´§ï¼";
                title.className = "text-2xl font-bold mb-2 text-red-500";
                desc.innerText = "æµé‡æ²¡æ¥ä½ï¼ŒIPI åˆ†æ•°è·Œç ´çº¢çº¿ï¼Œæ˜å¹´å†æˆ˜å§ã€‚";
                icon.className = "fas fa-ban text-6xl text-red-500 mb-4 animate-pulse";
            }
        }

        function updateUI() {
            document.getElementById('score-display').innerText = gameState.score;
            document.getElementById('ipi-value').innerText = gameState.ipi;
            
            // IPI é¢œè‰²å˜åŒ–
            const ipiEl = document.getElementById('ipi-value');
            if (gameState.ipi < 400) ipiEl.className = "font-bold text-red-500 animate-pulse";
            else if (gameState.ipi < 500) ipiEl.className = "font-bold text-yellow-400";
            else ipiEl.className = "font-bold text-green-400";

            // è¿›åº¦æ¡
            const pct = Math.max(0, Math.min(100, (gameState.ipi / MAX_IPI) * 100));
            document.getElementById('ipi-bar').style.width = pct + "%";
        }

        // --- è¾“å…¥æ§åˆ¶ ---

        function movePaddle(clientX) {
            const rect = canvas.getBoundingClientRect();
            const relativeX = clientX - rect.left;
            
            const scaleX = (canvas.width / dpr) / rect.width;
            const canvasX = relativeX * scaleX;

            paddle.x = canvasX - paddle.width / 2;

            // è¾¹ç•Œæ£€æŸ¥
            if (paddle.x < 0) paddle.x = 0;
            if (paddle.x + paddle.width > canvas.width / dpr) paddle.x = (canvas.width / dpr) - paddle.width;
        }

        // é¼ æ ‡
        document.addEventListener("mousemove", (e) => {
            if (isRunning) movePaddle(e.clientX);
        });

        // è§¦æ‘¸
        canvas.addEventListener("touchmove", (e) => {
            if (isRunning) {
                e.preventDefault();
                movePaddle(e.touches[0].clientX);
            }
        }, { passive: false });
        
        canvas.addEventListener("touchstart", (e) => {
             if (isRunning) {
                e.preventDefault();
                movePaddle(e.touches[0].clientX);
            }
        }, { passive: false });

        // --- ç‰¹æ•ˆè¾…åŠ© ---
        function createFloatingText(x, y, text, color = "#22c55e") {
            const el = document.createElement('div');
            el.className = 'floating-text';
            el.innerText = text;
            el.style.color = color;
            
            const rect = canvas.getBoundingClientRect();
            const scaleX = rect.width / (canvas.width / dpr);
            const scaleY = rect.height / (canvas.height / dpr);
            
            const screenX = rect.left + (x * scaleX);
            const screenY = rect.top + (y * scaleY);

            el.style.left = screenX + 'px';
            el.style.top = screenY + 'px';
            
            document.body.appendChild(el);
            setTimeout(() => el.remove(), 800);
        }

        // åˆå§‹è°ƒç”¨ä¸€æ¬¡
        resizeGame();

    </script>
</body>
</html>